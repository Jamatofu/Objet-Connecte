<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>MQTT IHM</title>
        <link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js" type="text/javascript"></script>

        <script type="text/javascript">
            var mqtt;
            var reconnectTimeout = 2000;
            var host = "localhost";
            var port = 9001;

            function onConnect() {
                console.log("COnencted => " + idRaspberry);
                mqtt.subscribe(idRaspberry + "/test");
                mqtt.subscribe(idRaspberry + "/temperature");
                message = new Paho.MQTT.Message("Salut");
                message.destinationName = "test";
                mqtt.send(message);
            }

            function onMessageArrived(msg) {
                let path = msg.destinationName.substr(msg.destinationName.indexOf('/') + 1);
                console.log(path);

                switch (path) {
                    case "temperature":
                        updateTemperatureChart(msg.payloadString);
                        break;
                    default:

                }
            }

            function MQTTconnect() {
                console.log("connecting to " + host + " " + port);
                mqtt = new Paho.MQTT.Client(host, port, "client.js");

                var options = {
                        timeout: 3,
                        onSuccess: onConnect
                };
                mqtt.onMessageArrived = onMessageArrived;

                mqtt.connect(options);
            }
        </script>
    </head>
    <body>

        <div class="container">
            <h3>Actions sur l'aquarium</h1>
            <button type="button" class="button-click" id="buttonFile">Chauffage</button>
            <button type="button" class="button-click" id="buttonFile">Distribuer la nourriture</button>
        </div>

        <div class="container">
            <h3 id="titleChart">Température</h3>
                <canvas id="chart" width="200" height="200"></canvas>

            <select class="select-long" id="sensorKind" onchange="updateSensorChart(this)">
                <option value="temperature">Température</option>
                <option value="water">Niveau d'eau</option>
            </select>
        </div>













        <script type="text/javascript">
            let idRaspberry = window.location.pathname.substr(1);
            console.log(idRaspberry);

            MQTTconnect();

            var ctx = document.getElementById("chart");
            let myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{
                            type: 'time',
                            distribution: 'linear',
                            time: {
                                unit: 'second',
                                source: 'data'
                            }
                        }],
                        yAxes: [{
                            distribution: 'linear',
                            ticks: {
                                min: 10,
                                max: 40
                            }
                        }]
                    }
                }
            });

            function updateTemperatureChart(value) {
                let data = {
                    x: new Date(),
                    y: value
                };

                myChart.data.datasets.forEach((dataset) => {
                    dataset.data.push(data);
                });

                myChart.update();
            }

            function updateSensorChart(e) {
                let titleHeader = document.getElementById('titleChart');

                switch (e.value) {
                    case "water":
                        titleHeader.innerText = "Niveau d'eau";
                        break;
                    case "temperature":
                        titleHeader.innerText = "Température";
                        break;
                }

                myChart.data.datasets[0].data.pop();
            }
        </script>
    </body>
</html>
